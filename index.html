<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2-Up PDF Landscape Converter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            min-height: 100vh;
        }
    </style>
    <!-- Load PDF-lib for in-browser PDF manipulation -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 md:p-8 flex flex-col items-center">
        <header class="w-full max-w-3xl text-center py-6">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">2-Up Landscape PDF Converter</h1>
            <p class="text-gray-600 text-lg">Combine two portrait pages onto one landscape A4 sheet with auto-numbering. The file is processed entirely in your browser.</p>
        </header>

        <main class="w-full max-w-3xl bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-indigo-100">

            <!-- File Upload Area -->
            <div class="mb-8">
                <label for="pdf-file" class="block text-xl font-semibold text-gray-700 mb-3">
                    1. Upload Your PDF File
                </label>
                <div class="relative border-2 border-dashed border-indigo-300 rounded-lg p-6 hover:border-indigo-500 transition-all duration-200 cursor-pointer">
                    <input type="file" id="pdf-file" accept="application/pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                    <div id="upload-message" class="text-center">
                        <svg class="mx-auto h-12 w-12 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.884-7.884l1.17-1.463A6.002 6.002 0 0117 8a6 6 0 01-1.353 3.754l-.427.534A4 4 0 017 16zM12 10v6m-3-3l3 3m0 0l3-3"/>
                        </svg>
                        <p class="mt-2 text-sm text-gray-600"><span class="font-medium text-indigo-600">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500" id="file-status">No file selected.</p>
                    </div>
                </div>
            </div>

            <!-- Conversion Button -->
            <div class="mb-8">
                <button id="convert-button" onclick="convertPDF()"
                    class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    <svg id="button-icon" class="h-6 w-6 mr-2 transition-all duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span id="button-text">Convert & Combine Pages</span>
                </button>
                <div id="error-message" class="mt-3 text-red-600 text-center font-medium hidden"></div>
            </div>

            <!-- Result Area -->
            <div id="result-area" class="mt-6 p-4 bg-green-50 border border-green-300 rounded-lg hidden">
                <h3 class="text-xl font-semibold text-green-700 mb-2 flex items-center">
                    <svg class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Conversion Complete!
                </h3>
                <p class="text-gray-700 mb-4">Your combined PDF is ready to download. The page count has been halved, and each new page is in landscape A4 format with combined page numbers in the footer.</p>
                <a id="download-link" href="#" download="combined_landscape_document.pdf"
                   class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 transition-all duration-200">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Download combined_landscape_document.pdf
                </a>
            </div>

            <!-- Processing Info -->
            <div class="mt-6 pt-6 border-t border-gray-100">
                 <h3 class="text-lg font-semibold text-gray-700 mb-2">How it works:</h3>
                 <ul class="text-sm text-gray-500 space-y-1 list-disc list-inside">
                    <li>The app pairs original pages (1+2, 3+4, etc.).</li>
                    <li>It creates a new **A4 Landscape** page (842x595 points).</li>
                    <li>The two original portrait pages are scaled down and placed side-by-side to fit perfectly.</li>
                    <li>A footer is added to the new page showing "Pages X and Y".</li>
                    <li>If the PDF has an odd number of pages, the last page is added to a new landscape page by itself.</li>
                 </ul>
            </div>

        </main>
    </div>

    <script>
        const { PDFDocument, StandardFonts, rgb } = window.PDFLib;
        const fileInput = document.getElementById('pdf-file');
        const convertButton = document.getElementById('convert-button');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');
        const fileStatus = document.getElementById('file-status');
        const resultArea = document.getElementById('result-area');
        const downloadLink = document.getElementById('download-link');
        const errorMessage = document.getElementById('error-message');

        let selectedFile = null;

        // A4 Landscape dimensions in points
        const A4_LANDSCAPE_WIDTH = 842;
        const A4_LANDSCAPE_HEIGHT = 595;
        // A4 Portrait Dimensions (Fallback)
        const A4_PORTRAIT_WIDTH = 595.28;
        const A4_PORTRAIT_HEIGHT = 841.89;

        // Utility to handle file selection and update UI
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            errorMessage.classList.add('hidden');
            resultArea.classList.add('hidden');

            if (selectedFile) {
                fileStatus.textContent = `File selected: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                convertButton.disabled = false;
            } else {
                fileStatus.textContent = 'No file selected.';
                convertButton.disabled = true;
            }
        }

        /**
         * Main conversion function: Loads the PDF, calculates robust scaling, and draws pages.
         */
        async function convertPDF() {
            if (!selectedFile) {
                alertUser('Please select a PDF file first.');
                return;
            }

            setLoading(true);

            try {
                const pdfBytes = await selectedFile.arrayBuffer();
                const originalPdfDoc = await PDFDocument.load(pdfBytes);
                const pageCount = originalPdfDoc.getPageCount();

                if (pageCount < 1) {
                    alertUser('The selected PDF has no pages.');
                    return;
                }

                const combinedPdfDoc = await PDFDocument.create();
                const font = await combinedPdfDoc.embedFont(StandardFonts.Helvetica);

                // Process pages in pairs
                for (let i = 0; i < pageCount; i += 2) {
                    const firstOriginalPageIndex = i;
                    const secondOriginalPageIndex = i + 1;

                    const firstOriginalPage = originalPdfDoc.getPages()[firstOriginalPageIndex];
                    const secondOriginalPage = secondOriginalPageIndex < pageCount ? originalPdfDoc.getPages()[secondOriginalPageIndex] : null;

                    // --- Robust Scaling Calculation with Fallback ---

                    let originalHeight = firstOriginalPage.height;
                    let originalWidth = firstOriginalPage.width;

                    // Check for invalid dimensions, and fall back to A4 Portrait if necessary.
                    if (!Number.isFinite(originalHeight) || !Number.isFinite(originalWidth) || originalHeight <= 0 || originalWidth <= 0) {
                        console.warn(`[WARNING] Invalid dimensions found for page ${firstOriginalPageIndex + 1} (${originalWidth}x${originalHeight}). Falling back to A4 Portrait dimensions (${A4_PORTRAIT_WIDTH}x${A4_PORTRAIT_HEIGHT}).`);
                        originalHeight = A4_PORTRAIT_HEIGHT;
                        originalWidth = A4_PORTRAIT_WIDTH;
                    }

                    // 1. Scale factor needed to fit the page HEIGHT into the new landscape HEIGHT (595)
                    const heightScaleFactor = A4_LANDSCAPE_HEIGHT / originalHeight;
                    
                    // 2. Scale factor needed to ensure two scaled pages fit the landscape WIDTH (842)
                    const widthScaleFactor = A4_LANDSCAPE_WIDTH / (originalWidth * 2);

                    // Use the smaller scale factor to guarantee the pages fit within both constraints
                    const finalScaleFactor = Math.min(heightScaleFactor, widthScaleFactor);

                    const finalScaledWidth = originalWidth * finalScaleFactor;
                    const finalScaledHeight = originalHeight * finalScaleFactor;

                    // --- End Scaling Calculation ---
                    
                    const pageIndices = [];
                    
                    let embeddedPage1 = null;
                    let embeddedPage2 = null;

                    // 1. Try to embed the First Page (Left Side)
                    try {
                        embeddedPage1 = await combinedPdfDoc.embedPage(firstOriginalPage);
                    } catch (embedError) {
                        console.warn(`[WARNING] Failed to embed original page ${firstOriginalPageIndex + 1} (Missing Contents/Corrupt). Skipping this page pair.`);
                        // If the first page is corrupt, skip the entire pair and continue to the next iteration
                        continue; 
                    }

                    // 2. Try to embed the Second Page (Right Side), if it exists
                    if (secondOriginalPage) {
                        try {
                            embeddedPage2 = await combinedPdfDoc.embedPage(secondOriginalPage);
                        } catch (embedError) {
                            console.warn(`[WARNING] Failed to embed original page ${secondOriginalPageIndex + 1} (Missing Contents/Corrupt). Treating this as an odd page count.`);
                            // embeddedPage2 remains null, and we only draw embeddedPage1
                        }
                    }

                    // Create the new landscape page
                    const combinedPage = combinedPdfDoc.addPage([A4_LANDSCAPE_WIDTH, A4_LANDSCAPE_HEIGHT]);

                    const isTwoPages = embeddedPage2 !== null;

                    // Center the content horizontally.
                    const xCenterOffset = (A4_LANDSCAPE_WIDTH - (finalScaledWidth * (isTwoPages ? 2 : 1))) / 2; 
                    
                    // Draw First Page
                    combinedPage.drawPage(embeddedPage1, {
                        x: xCenterOffset, // Start drawing with optional centering offset
                        y: 0,
                        width: finalScaledWidth,
                        height: finalScaledHeight,
                    });
                    pageIndices.push(firstOriginalPageIndex + 1); // Store original page number

                    // Draw Second Page
                    if (isTwoPages) {
                        combinedPage.drawPage(embeddedPage2, {
                            x: xCenterOffset + finalScaledWidth, // Start drawing next to the first page
                            y: 0,
                            width: finalScaledWidth,
                            height: finalScaledHeight,
                        });
                        pageIndices.push(secondOriginalPageIndex + 1); // Store original page number
                    }

                    // 3. Add Footer with combined page numbering
                    const footerText = pageIndices.length === 2
                        ? `Original Pages ${pageIndices[0]} and ${pageIndices[1]}`
                        : `Original Page ${pageIndices[0]} (Odd Page Count)`;
                    const footerFontSize = 10;
                    const textWidth = font.widthOfTextAtSize(footerText, footerFontSize);
                    const padding = 15;
                    const xPosition = A4_LANDSCAPE_WIDTH / 2 - textWidth / 2; // Center alignment
                    const yPosition = padding; // Bottom margin

                    combinedPage.drawText(footerText, {
                        x: xPosition,
                        y: yPosition,
                        size: footerFontSize,
                        font: font,
                        color: rgb(0.3, 0.3, 0.3), // Dark grey
                    });
                }
                
                // Final check to see if any pages were successfully converted
                if (combinedPdfDoc.getPageCount() === 0) {
                    throw new Error("No valid pages could be processed. The entire document may be corrupted.");
                }

                // Serialize the PDFDocument to bytes (a Uint8Array)
                const pdfBytesOutput = await combinedPdfDoc.save();

                // Create a Blob and a download link
                const blob = new Blob([pdfBytesOutput], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                downloadLink.href = url;
                resultArea.classList.remove('hidden');
                
            } catch (error) {
                console.error("PDF Conversion Error:", error);
                alertUser(`An error occurred during conversion: ${error.message}. Please check your PDF file.`, true);
            } finally {
                setLoading(false);
            }
        }

        // Helper function for custom non-blocking alert/error display
        function alertUser(message, isError = false) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            if (!isError) {
                // For non-error messages, hide after a few seconds
                setTimeout(() => errorMessage.classList.add('hidden'), 5000);
            }
        }

        // Helper function to manage loading state
        function setLoading(isLoading) {
            convertButton.disabled = isLoading || !selectedFile;
            if (isLoading) {
                buttonText.textContent = 'Processing... Please wait.';
                // Use a standard spin animation
                buttonIcon.classList.remove('animate-pulse', 'rotate-0'); 
                buttonIcon.classList.add('animate-spin');
            } else {
                buttonText.textContent = 'Convert & Combine Pages';
                buttonIcon.classList.remove('animate-spin');
                buttonIcon.classList.add('rotate-0');
            }
        }
    </script>
</body>
</html>
